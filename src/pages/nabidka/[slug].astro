---
import ProductPage from "../../layouts/ProductPage.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { generateSlug } from "../../content/config";
import { formatPrice } from "../../utils/price-format";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  const products = await getCollection("nabidka");
  return products.map((product: CollectionEntry<"nabidka">) => ({
    params: { slug: generateSlug(product.data.model, product.data.id) },
    props: { product },
  }));
}

interface Props {
  product: CollectionEntry<"nabidka">;
}

const { product } = Astro.props as Props;
const { Content } = await product.render();

// db pull
const productDatabase = await getCollection("nabidka");

// Filter related products
const relatedProducts = productDatabase
  .filter(p => 
    // Exclude current product
    p.data.id !== product.data.id && 
    // Check for matching categories
    p.data.categories.some(cat => product.data.categories.includes(cat))
  )
  // Sort by number of matching categories for most relevant first
  .sort((a, b) => {
    const aMatches = a.data.categories.filter(cat => product.data.categories.includes(cat)).length;
    const bMatches = b.data.categories.filter(cat => product.data.categories.includes(cat)).length;
    return bMatches - aMatches;
  })
  .slice(0, 3);
---

<ProductPage frontmatter={product.data} backPath="/nabidka" backText="Zpět na nabídku">
  <Content slot="content"/>

  <!-- RELATED PRODUCTS -->
  <section slot="related" class="section-related-products">
    <div class="related-products-container">
      <h2 class="heading-2">Související produkty</h2>
      <hr class="__separator separator-heading" />
      <div class="products-horizon">
        {relatedProducts.slice(0, 3).map((product: CollectionEntry<"nabidka">) => (
          <a href={`/nabidka/${generateSlug(product.data.model, product.data.id)}`} class="product-card" data-id={product.data.id} data-price={product.data.price} data-categories={product.data.categories.join(',')}>
            <figure class="product-body">
              <Image
                src={product.data.coverImage.src}
                alt={product.data.coverImage.alt || `Doprovázející obrázek produktu ${product.data.model}`}
                class="__image product-image"
                quality={100}
                format="webp"
                loading="lazy"
              />
              <figcaption class="product-description">
                <span class="product-name">
                  {product.data.model}
                </span>
                <span class="product-price">
                  {formatPrice(product.data.price)}
                </span>
              </figcaption>
            </figure>
          </a>
        ))}
      </div>
      <a href="nabidka.html" class="button-link">
        Zobrazit celou nabídku
      </a>
    </div>
  </section>
</ProductPage>